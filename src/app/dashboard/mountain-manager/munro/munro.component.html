@if (munroLoading) {
  <app-loading-indicator></app-loading-indicator>
} @else {
  <div class="w-full max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-6 sm:py-8">
    <!-- Shell: dashboard card -->
    <div
      class="bg-white rounded-2xl border border-slate-200
             shadow-[0_1px_0_rgba(15,23,42,0.04)]
             overflow-hidden"
    >
      <!-- Header strip -->
      <div class="px-5 sm:px-6 py-5 sm:py-6 bg-slate-50/70 border-b border-slate-200 relative">
        <!-- Back Button -->
        <a
          class="inline-flex items-center gap-2 text-slate-600 hover:text-slate-900 text-sm font-semibold
                 px-3 py-2 rounded-xl
                 hover:bg-white/70 border border-transparent hover:border-slate-200
                 shadow-none hover:shadow-[0_1px_0_rgba(15,23,42,0.04)]
                 transition w-fit"
          [routerLink]="['/dashboard/mountain-manager']"
          aria-label="Back to Munro Manager"
        >
          <i class="fa-solid fa-arrow-left-long text-sm"></i>
          <span>Back</span>
        </a>

        <!-- Title + avatar -->
        <div class="mt-4 flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4">
          <div class="min-w-0 text-center sm:text-left">
            <h1 class="text-xl sm:text-3xl font-semibold text-slate-900 truncate">
              {{ selectedMunro.hill_name }}
            </h1>
            <p class="mt-1 text-sm text-slate-500">
              {{ selectedMunro.height }}m
            </p>
          </div>

          <div class="flex items-center justify-center sm:justify-end gap-3">
            <img
              [src]="selectedMunro.image_url"
              alt="{{ selectedMunro.hill_name }}"
              class="w-16 h-16 sm:w-20 sm:h-20 object-cover rounded-2xl
                     border border-slate-200
                     shadow-[0_1px_0_rgba(15,23,42,0.04)]
                     bg-white"
            />

            <!-- Badge -->
            <span
              class="inline-flex items-center gap-2 text-[11px] font-semibold px-3 py-1.5 rounded-full
                     bg-white/90 backdrop-blur
                     border border-slate-200
                     shadow-[0_1px_0_rgba(15,23,42,0.06)]"
            >
              <span
                class="inline-block w-2 h-2 rounded-full"
                [ngClass]="{
                  'bg-emerald-500': !isNewCompletedMunro,
                  'bg-rose-500': isNewCompletedMunro
                }"
              ></span>
              {{ isNewCompletedMunro ? 'Not complete' : 'Completed' }}
            </span>
          </div>
        </div>
      </div>

      <!-- Content -->
      <div class="px-5 sm:px-6 py-6">
        <!-- Edit Mode -->
        @if (editMode) {
          <form [formGroup]="completedMunroForm" class="space-y-6">
            <!-- Notes -->
            <div>
              <label for="notes" class="block text-sm font-semibold text-slate-700 mb-2">Notes</label>
              <textarea
                id="notes"
                formControlName="notes"
                class="w-full px-4 py-3 text-sm text-slate-900 placeholder:text-slate-400
                       bg-white border border-slate-200 rounded-2xl
                       shadow-[0_1px_0_rgba(15,23,42,0.04)]
                       focus:outline-none focus:ring-4 focus:ring-blue-500/10 focus:border-blue-300
                       transition resize-none min-h-[110px]"
                placeholder="Any notes about your hike..."
              ></textarea>
            </div>

            <!-- Rating -->
            <div>
              <label class="block text-sm font-semibold text-slate-700 mb-2">Rating</label>
              <div class="inline-flex items-center rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3">
                <app-rating [rating]="completedMunro.rating" (ratingChange)="onRatingChanged($event)"></app-rating>
              </div>
            </div>

            <!-- Photo Upload -->
            <div>
              <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-3">
                <h2 class="text-sm sm:text-base font-semibold text-slate-900">Hike Photos</h2>

                <button
                  type="button"
                  class="inline-flex items-center justify-center gap-2 px-3.5 py-2 rounded-xl
                         bg-white border border-slate-200
                         shadow-[0_1px_0_rgba(15,23,42,0.04)]
                         text-slate-700 hover:text-slate-900
                         hover:border-slate-300 hover:shadow-[0_10px_30px_rgba(15,23,42,0.08)]
                         text-sm font-semibold transition w-full sm:w-auto"
                  (click)="photoInput.click()"
                >
                  <i class="fa-solid fa-upload text-sm"></i>
                  Upload Photos
                </button>

                <input
                  #photoInput
                  type="file"
                  accept="image/*"
                  multiple
                  class="hidden"
                  (change)="onPhotosSelected($event)"
                />
              </div>

              <!-- Photo Grid -->
              <div *ngIf="completedMunro.summitImages?.length || selectedPhotos?.length; else noPhotos">
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
                  <ng-container *ngFor="let img of completedMunro.summitImages || []">
                    <div
                      class="relative group rounded-2xl overflow-hidden border border-slate-200 bg-slate-100
                             shadow-[0_1px_0_rgba(15,23,42,0.04)]
                             hover:shadow-[0_10px_30px_rgba(15,23,42,0.08)]
                             hover:border-slate-300 transition cursor-pointer"
                      (click)="openPhoto(img)"
                    >
                      <img
                        [src]="img"
                        alt="Summit hike photo"
                        class="w-full h-28 object-cover transition-transform duration-300 group-hover:scale-[1.03]"
                      />
                      <div
                        class="absolute inset-0 bg-slate-900/35 opacity-0 group-hover:opacity-100
                               flex items-center justify-center transition"
                      >
                        <i class="fa-solid fa-up-right-and-down-left-from-center text-white text-lg"></i>
                      </div>
                    </div>
                  </ng-container>

                  <ng-container *ngFor="let photo of selectedPhotos || []">
                    <div
                      class="relative group rounded-2xl overflow-hidden border border-slate-200 bg-slate-100
                             shadow-[0_1px_0_rgba(15,23,42,0.04)]
                             hover:shadow-[0_10px_30px_rgba(15,23,42,0.08)]
                             hover:border-slate-300 transition cursor-pointer"
                      (click)="openPhoto(photo.preview)"
                    >
                      <img
                        [src]="photo.preview"
                        alt="Selected hike photo"
                        class="w-full h-28 object-cover transition-transform duration-300 group-hover:scale-[1.03]"
                      />
                      <div
                        class="absolute inset-0 bg-slate-900/35 opacity-0 group-hover:opacity-100
                               flex items-center justify-center transition"
                      >
                        <i class="fa-solid fa-up-right-and-down-left-from-center text-white text-lg"></i>
                      </div>
                    </div>
                  </ng-container>
                </div>
              </div>

              <ng-template #noPhotos>
                <div class="rounded-2xl border border-dashed border-slate-200 bg-slate-50 px-4 py-8">
                  <div class="flex flex-col items-center text-slate-500 text-center">
                    <i class="fa-solid fa-camera text-xl mb-2 text-slate-400"></i>
                    <span class="text-sm">You haven't added any photos from this hike yet.</span>
                  </div>
                </div>
              </ng-template>
            </div>

            <!-- Buttons -->
            <div class="space-y-2 pt-2">
              <button
                type="submit"
                class="w-full inline-flex items-center justify-center rounded-2xl
                       bg-slate-900 text-white py-2.5 font-semibold
                       shadow-[0_1px_0_rgba(15,23,42,0.12)]
                       hover:shadow-[0_10px_30px_rgba(15,23,42,0.18)]
                       hover:bg-slate-950 transition"
                (click)="saveCompletedMunro()"
              >
                @if (munroSaving) {
                  <app-loading-indicator [spinner]="true"></app-loading-indicator>
                } @else { Save }
              </button>

              <button
                *ngIf="!isNewCompletedMunro"
                type="button"
                (click)="removeCompletedMunro()"
                class="w-full inline-flex items-center justify-center rounded-2xl
                       bg-white text-slate-900 border border-slate-200 py-2.5 font-semibold
                       shadow-[0_1px_0_rgba(15,23,42,0.04)]
                       hover:shadow-[0_10px_30px_rgba(15,23,42,0.08)]
                       hover:border-slate-300 transition"
              >
                Mark as incomplete
              </button>

              <button
                type="button"
                (click)="editMode = false"
                class="w-full inline-flex items-center justify-center rounded-2xl
                       bg-white text-slate-700 border border-slate-200 py-2.5 font-semibold
                       hover:text-slate-900 hover:border-slate-300 transition"
              >
                Cancel
              </button>
            </div>
          </form>
        } @else {
          <!-- View Mode -->
          <div class="space-y-6">
            <!-- Notes -->
            <div>
              <div class="text-sm font-semibold text-slate-700 mb-2">Notes</div>
              <div
                class="bg-slate-50 border border-slate-200 text-slate-900 text-sm rounded-2xl px-4 py-3
                       min-h-[56px]
                       shadow-[0_1px_0_rgba(15,23,42,0.04)]"
              >
                {{ completedMunro.notes || 'No notes added.' }}
              </div>
            </div>

            <!-- Rating -->
            <div>
              <div class="text-sm font-semibold text-slate-700 mb-2">Rating</div>
              <div class="inline-flex items-center rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3">
                <app-rating [rating]="completedMunro.rating" [readonly]="true"></app-rating>
              </div>
            </div>

            <!-- Photos -->
            <div>
              <div class="text-sm font-semibold text-slate-700 mb-2">Hike Photos</div>
              <div *ngIf="completedMunro.summitImages?.length; else noViewPhotos">
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
                  <ng-container *ngFor="let img of completedMunro.summitImages">
                    <div
                      class="relative group rounded-2xl overflow-hidden border border-slate-200 bg-slate-100
                             shadow-[0_1px_0_rgba(15,23,42,0.04)]
                             hover:shadow-[0_10px_30px_rgba(15,23,42,0.08)]
                             hover:border-slate-300 transition cursor-pointer"
                      (click)="openPhoto(img)"
                    >
                      <img
                        [src]="img"
                        alt="Summit photo"
                        class="w-full h-28 object-cover transition-transform duration-300 group-hover:scale-[1.03]"
                      />
                      <div
                        class="absolute inset-0 bg-slate-900/35 opacity-0 group-hover:opacity-100
                               flex items-center justify-center transition"
                      >
                        <i class="fa-solid fa-up-right-and-down-left-from-center text-white text-lg"></i>
                      </div>
                    </div>
                  </ng-container>
                </div>
              </div>

              <ng-template #noViewPhotos>
                <div class="rounded-2xl border border-dashed border-slate-200 bg-slate-50 px-4 py-8">
                  <div class="flex flex-col items-center text-slate-500 text-center">
                    <i class="fa-solid fa-camera text-xl mb-2 text-slate-400"></i>
                    <span class="text-sm">No photos added yet.</span>
                  </div>
                </div>
              </ng-template>
            </div>

            <!-- Edit Button -->
            <div class="pt-2">
              <button
                type="button"
                class="w-full inline-flex items-center justify-center rounded-2xl
                       bg-slate-900 text-white py-2.5 font-semibold
                       shadow-[0_1px_0_rgba(15,23,42,0.12)]
                       hover:shadow-[0_10px_30px_rgba(15,23,42,0.18)]
                       hover:bg-slate-950 transition"
                (click)="editMode = true"
              >
                {{ isNewCompletedMunro ? 'Mark as complete' : 'Edit' }}
              </button>
            </div>
          </div>
        }

        <!-- Expanded Photo Modal -->
        @if (expandedPhoto) {
          <div
            class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4"
            (click)="closePhoto()"
          >
            <div
              class="relative w-full max-w-md sm:max-w-3xl h-[60vh] flex items-center justify-center"
              (click)="$event.stopPropagation()"
            >
              <button
                (click)="closePhoto()"
                class="absolute top-3 right-3 z-10 inline-flex items-center justify-center
                       h-10 w-10 rounded-xl bg-white/10 hover:bg-white/20 text-white transition"
              >
                <i class="fa-solid fa-xmark text-lg"></i>
              </button>

              <div
                class="w-full h-full bg-cover bg-center rounded-2xl
                       shadow-[0_30px_80px_rgba(15,23,42,0.55)]
                       border border-white/10"
                [ngStyle]="{ 'background-image': 'url(' + expandedPhoto + ')' }"
              ></div>
            </div>
          </div>
        }
      </div>
    </div>
  </div>
}
